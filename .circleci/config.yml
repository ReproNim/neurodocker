---
_machine_kwds: &machine_kwds
  image: circleci/classic:201711-01

_checkout_kwds: &checkout_kwds
  path: ~/neurodocker

_setup_env: &setup_kwds
  name: Setup environment
  command: |
    pyenv global 3.5.2
    pip install -U --no-cache-dir pip
    pip install --no-cache-dir dropbox pytest-cov reprozip
    pip install -e ~/neurodocker

_save_cache_kwds: &save_cache_kwds
  key: dockerfiles-v0-{{ .Branch }}-{{ .Revision }}
  paths:
    - /tmp/cache

_restore_cache_kwds: &restore_cache_kwds
  keys:
    - dockerfiles-v0-{{ .Branch }}-{{ .Revision }}
    - dockerfiles-v0-{{ .Branch }}


version: 2
jobs:
  test_docker:
    machine:
      *machine_kwds
    steps:
      - checkout:
          *checkout_kwds
      - run:
          *setup_kwds
      - restore_cache:
          *restore_cache_kwds
      - run:
          name: Test docker image builds
          no_output_timeout: 360m
          command: |
            pytest -k 'test_docker' ~/neurodocker/neurodocker
      - save_cache:
          *save_cache_kwds

  test_singularity:
    machine:
      *machine_kwds
    steps:
      - checkout:
          *checkout_kwds
      - run:
          *setup_kwds
      - restore_cache:
          *restore_cache_kwds
      - run:
          name: Test singularity image builds
          no_output_timeout: 360m
          command: |
            pytest -k 'test_singularity' ~/neurodocker/neurodocker
      - save_cache:
          *save_cache_kwds


  test_others:
    machine:
      *machine_kwds
    steps:
      - checkout:
          *checkout_kwds
      - run:
          *setup_kwds
      - restore_cache:
          *restore_cache_kwds
      - run:
          name: Test others (not docker or singularity)
          no_output_timeout: 30m
          command: |
            pytest -k 'not test_docker and not test_singularity' ~/neurodocker/neurodocker
      - save_cache:
          *save_cache_kwds


workflows:
  version: 2
  build_test_deploy:
    jobs:
      - test_docker
      - test_singularity
      - test_others

# TODO(kaczmarj): add test_singularity step
