---
name: Publish container to GHCR on release

on:
    release:
        types: [published]

permissions:
    contents: read
    packages: write

jobs:
    publish-container:
        runs-on: ubuntu-latest
        steps:
        -   uses: actions/checkout@v6

        -   name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3

        -   name: Log in to GHCR
            uses: docker/login-action@v3
            with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

        -   name: Compute image tags
            id: image
            run: |
                image="ghcr.io/${GITHUB_REPOSITORY,,}"
                release_tag="${{ github.event.release.tag_name }}"
                tags="${image}:${release_tag}"
                if [ "${{ github.event.release.prerelease }}" = "false" ]; then
                  tags="${tags}\n${image}:latest"
                fi
                {
                  echo "tags<<EOF"
                  printf '%b\n' "$tags"
                  echo "EOF"
                } >> "$GITHUB_OUTPUT"

        -   name: Build and push container
            uses: docker/build-push-action@v6
            with:
                context: .
                file: Dockerfile
                push: true
                tags: ${{ steps.image.outputs.tags }}
                cache-from: type=gha
                cache-to: type=gha,mode=max
