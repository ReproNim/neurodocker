---
name: Publish Docker image

on:
    release:
        types: [published]
    push:
        branches:
        -   master
    workflow_dispatch:

permissions:
    contents: read

concurrency:
    group: docker-publish-${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    publish-dockerhub:
        runs-on: ubuntu-latest
        if: github.repository == 'ReproNim/neurodocker'
        steps:
        -   uses: actions/checkout@v6

        -   name: Validate Docker Hub credentials
            run: |
                if [[ -n "${DOCKERHUB_USERNAME}" && -n "${DOCKERHUB_TOKEN}" ]]; then
                    echo "Using DOCKERHUB_USERNAME/DOCKERHUB_TOKEN secrets"
                elif [[ -n "${DOCKER_LOGIN}" && -n "${DOCKER_TOKEN}" ]]; then
                    echo "Using legacy DOCKER_LOGIN/DOCKER_TOKEN secrets"
                else
                    echo "::error::Missing Docker Hub credentials. Configure DOCKERHUB_USERNAME+DOCKERHUB_TOKEN or DOCKER_LOGIN+DOCKER_TOKEN secrets."
                    exit 1
                fi
            env:
                DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
                DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
                DOCKER_LOGIN: ${{ secrets.DOCKER_LOGIN }}
                DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}

        -   name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3

        -   name: Login to Docker Hub
            uses: docker/login-action@v3
            with:
                username: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_USERNAME || secrets.DOCKER_LOGIN }}
                password: ${{ secrets.DOCKERHUB_TOKEN != '' && secrets.DOCKERHUB_TOKEN || secrets.DOCKER_TOKEN }}

        -   name: Extract Docker metadata
            id: meta
            uses: docker/metadata-action@v5
            with:
                images: repronim/neurodocker
                tags: |
                    type=raw,value=master,enable=${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
                    type=raw,value=latest,enable=${{ github.event_name == 'release' }}
                    type=raw,value=${{ github.event.release.tag_name }},enable=${{ github.event_name == 'release' }}
                    type=sha,format=short,enable=${{ github.event_name == 'push' }}

        -   name: Build and push image
            uses: docker/build-push-action@v6
            with:
                context: .
                push: true
                tags: ${{ steps.meta.outputs.tags }}
                labels: ${{ steps.meta.outputs.labels }}
                platforms: linux/amd64
                cache-from: type=gha
                cache-to: type=gha,mode=max
