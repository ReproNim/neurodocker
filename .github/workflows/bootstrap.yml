---
# this workflow bootstraps the testing of the build the docker images
#
# - this will run the python script used to generate the workflows
#   based on a the jinja template
# - commit and push the generated workflows to the branch test_docker_build
#   where they will be executed

name: bootstrap

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

on:
    # Regenerate workflows when supported recipe templates change on master.
    push:
        branches: [master]
        paths:
        -   neurodocker/templates/*.yaml
    # Runs weekly on Sunday at 00:00 UTC.
    schedule:
    -   cron: '0 0 * * 0'
    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:

permissions:
    contents: write
    actions: write
jobs:
    bootstrap:
        runs-on: ubuntu-22.04

        steps:
        -   uses: actions/checkout@v6
            with:
                token: ${{ secrets.CI_FLOW }}
                fetch-depth: 0

        -   name: Set up Python
            uses: actions/setup-python@v6
            with:
                python-version: '3.11'

        -   name: Install dependencies
            run: python -m pip install jinja2 pyyaml

        -   name: Create workflows
            run: |
                if [ "${{ github.event_name }}" = "push" ]; then
                  echo "detecting changed recipe templates"
                  changed_recipes=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" -- 'neurodocker/templates/*.yaml' \
                    | sed -E 's#^neurodocker/templates/##; s#\.yaml$##' \
                    | sort -u)
                  if [ -z "$changed_recipes" ]; then
                    echo "no recipe template changes detected"
                    exit 0
                  fi
                fi

                git checkout -b test_docker_build

                if [ "${{ github.event_name }}" = "push" ]; then
                  echo "testing changed recipes:"
                  echo "$changed_recipes"
                  for recipe in $changed_recipes; do
                    case "$recipe" in
                      afni|ants|bids_validator|cat12|convert3d|dcm2niix|freesurfer|fsl|jq|matlabmcr|miniconda|mricron|mrtrix3|spm12)
                        python .github/workflows/create_workflows.py --software_name "${recipe}"
                        ;;
                      *)
                        echo "skipping unsupported recipe: ${recipe}"
                        ;;
                    esac
                  done
                else
                  software_name="all"
                  echo "testing all software"
                  python .github/workflows/create_workflows.py --software_name "${software_name}"
                fi

                ls -l .github/workflows
                git add .
                if git diff --cached --quiet; then
                  echo "no workflow updates to commit"
                  exit 0
                fi
                git config --global user.email "no-reply@repronim.org"
                git config --global user.name "Repronim neurodocker bot"
                git commit -m "added new workflows"
                git push origin --force test_docker_build
