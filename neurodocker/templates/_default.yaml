---
# Instructions to be run in the beginning of every Dockerfile generated by
# Neurodocker.

# TODO: read this about locales http://jaredmarkell.com/docker-and-locales/

name: _default
url: n/a
# Not actually source, but we do not want to provide URLs.
source:
    dependencies:
        apt:
        -   apt-utils
        -   bzip2
        -   ca-certificates
        -   curl
        -   locales
        -   unzip
        yum:
        -   bzip2
        -   ca-certificates
        -   unzip
        -   glibc-langpack-en
        -   glibc-locale-source
    env:
        LANG: en_US.UTF-8
        LC_ALL: en_US.UTF-8
        ND_ENTRYPOINT: /neurodocker/startup.sh
    instructions: |
        export ND_ENTRYPOINT="{{ self.env['ND_ENTRYPOINT'] }}"
        {%- if self.pkg_manager == "yum" %}
        if ls /etc/yum.repos.d/CentOS-* >/dev/null 2>&1; then
            sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
            sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*;
        fi
        {%- endif %}
        {{ self.install_dependencies() }}
        {%- if self.pkg_manager == "apt" %}
        sed -i -e 's/# {{ self.env['LC_ALL'] }} UTF-8/{{ self.env['LC_ALL'] }} UTF-8/' /etc/locale.gen
        dpkg-reconfigure --frontend=noninteractive locales
        update-locale LANG="{{ self.env['LANG'] }}"
        {%- elif self.pkg_manager == "yum" %}
        localedef -i {{ self.env['LC_ALL'].split('.')[0] }} -f {{ self.env['LC_ALL'].split('.')[1] }} {{ self.env['LC_ALL'] }}
        {%- endif %}
        chmod 777 /opt && chmod a+s /opt
        mkdir -p /neurodocker
        if [ ! -f "$ND_ENTRYPOINT" ]; then
          echo '#!/usr/bin/env bash' >> "$ND_ENTRYPOINT"
          echo 'set -e' >> "$ND_ENTRYPOINT"
          echo 'export USER="${USER:=`whoami`}"' >> "$ND_ENTRYPOINT"
          echo 'if [ -n "$1" ]; then "$@"; else /usr/bin/env bash; fi' >> "$ND_ENTRYPOINT";
        fi
        chmod -R 777 /neurodocker && chmod a+s /neurodocker
